# =============================================================================
# AETHER Assets - Nginx Configuration
# =============================================================================
# Include this in your server block or create a separate location block
# Example: include /path/to/aether-assets.nginx.conf;
# =============================================================================

# -----------------------------------------------------------------------------
# MIME Types for Modern Formats
# -----------------------------------------------------------------------------
types {
    image/webp                            webp;
    image/avif                            avif;
    image/png                             png;
    image/jpeg                            jpg jpeg;
    image/gif                             gif;
    image/svg+xml                         svg svgz;
    application/json                      json;
    text/css                              css;
    application/javascript                js;
    font/woff2                            woff2;
    font/woff                             woff;
}

# -----------------------------------------------------------------------------
# Assets Location Block
# -----------------------------------------------------------------------------
location /assets/ {
    alias /var/www/html/assets/;
    
    # Enable gzip for text-based assets
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript 
               application/xml application/xml+rss text/javascript image/svg+xml;
    
    # Don't gzip already-compressed images
    gzip_disable "MSIE [1-6]\.";
    
    # CORS headers
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Timing-Allow-Origin "*" always;
    
    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Disable directory listing
    autoindex off;
    
    # -----------------------------------------------------------------------------
    # Image Caching (1 year, immutable)
    # -----------------------------------------------------------------------------
    location ~* \.(webp|avif|png|jpg|jpeg|gif|svg)$ {
        expires 1y;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Access-Control-Allow-Origin "*";
        
        # Content negotiation: serve AVIF if supported
        set $avif_suffix "";
        if ($http_accept ~* "image/avif") {
            set $avif_suffix ".avif";
        }
        
        # Try AVIF first, then original
        try_files $uri$avif_suffix $uri =404;
    }
    
    # -----------------------------------------------------------------------------
    # CSS/JS Caching (1 month)
    # -----------------------------------------------------------------------------
    location ~* \.(css|js)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
        add_header Access-Control-Allow-Origin "*";
    }
    
    # -----------------------------------------------------------------------------
    # JSON Manifests (1 day)
    # -----------------------------------------------------------------------------
    location ~* \.json$ {
        expires 1d;
        add_header Cache-Control "public, max-age=86400";
        add_header Access-Control-Allow-Origin "*";
    }
    
    # -----------------------------------------------------------------------------
    # Service Worker (no cache)
    # -----------------------------------------------------------------------------
    location = /assets/sw.js {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
        add_header Access-Control-Allow-Origin "*";
    }
}

# -----------------------------------------------------------------------------
# WebP/AVIF Content Negotiation Map (place in http block)
# -----------------------------------------------------------------------------
# map $http_accept $webp_suffix {
#     default   "";
#     "~*webp"  ".webp";
# }
# 
# map $http_accept $avif_suffix {
#     default   "";
#     "~*avif"  ".avif";
# }

# -----------------------------------------------------------------------------
# Rate Limiting for Asset Requests (optional, place in http block)
# -----------------------------------------------------------------------------
# limit_req_zone $binary_remote_addr zone=assets:10m rate=100r/s;
# 
# location /assets/ {
#     limit_req zone=assets burst=200 nodelay;
#     ...
# }

# -----------------------------------------------------------------------------
# HTTP/2 Server Push for Critical Assets (optional)
# -----------------------------------------------------------------------------
# location = / {
#     http2_push /assets/webp/aether-brand-logo-main.webp;
#     http2_push /assets/aether-assets.css;
#     http2_push /assets/aether-assets.js;
# }
