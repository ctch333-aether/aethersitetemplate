# =============================================================================
# AETHER Assets - Apache Configuration (.htaccess)
# =============================================================================
# Place this file in your /assets/ directory
# Requires: mod_headers, mod_expires, mod_deflate, mod_rewrite
# =============================================================================

# Enable rewrite engine
RewriteEngine On

# -----------------------------------------------------------------------------
# CORS Headers - Allow cross-origin requests for assets
# -----------------------------------------------------------------------------
<IfModule mod_headers.c>
    # Allow any origin (adjust for production)
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, OPTIONS"
    Header set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept"
    
    # Timing-Allow-Origin for performance monitoring
    Header set Timing-Allow-Origin "*"
</IfModule>

# -----------------------------------------------------------------------------
# Content Types - Ensure proper MIME types
# -----------------------------------------------------------------------------
<IfModule mod_mime.c>
    # Modern image formats
    AddType image/webp .webp
    AddType image/avif .avif
    
    # Standard formats
    AddType image/png .png
    AddType image/jpeg .jpg .jpeg
    AddType image/gif .gif
    AddType image/svg+xml .svg
    
    # Fonts
    AddType font/woff2 .woff2
    AddType font/woff .woff
    
    # Data
    AddType application/json .json
    AddType application/javascript .js
    AddType text/css .css
</IfModule>

# -----------------------------------------------------------------------------
# Compression - Reduce transfer sizes
# -----------------------------------------------------------------------------
<IfModule mod_deflate.c>
    # Compress text-based files
    AddOutputFilterByType DEFLATE text/html text/plain text/xml
    AddOutputFilterByType DEFLATE text/css text/javascript application/javascript
    AddOutputFilterByType DEFLATE application/json application/xml
    AddOutputFilterByType DEFLATE image/svg+xml
    
    # Don't compress already-compressed formats
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|avif)$ no-gzip
</IfModule>

# -----------------------------------------------------------------------------
# Caching - Browser cache control
# -----------------------------------------------------------------------------
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Default: 1 week
    ExpiresDefault "access plus 1 week"
    
    # Images: 1 year (versioned via filename or query string)
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/avif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    
    # CSS/JS: 1 month
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    
    # JSON manifests: 1 day (may update)
    ExpiresByType application/json "access plus 1 day"
    
    # HTML: no cache (always fetch fresh)
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>

<IfModule mod_headers.c>
    # Cache-Control headers
    <FilesMatch "\.(webp|avif|png|jpg|jpeg|gif|svg)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "public, max-age=2592000"
    </FilesMatch>
    
    <FilesMatch "\.json$">
        Header set Cache-Control "public, max-age=86400"
    </FilesMatch>
    
    # Remove ETags (not needed with expires)
    Header unset ETag
</IfModule>

FileETag None

# -----------------------------------------------------------------------------
# Content Negotiation - Serve best format automatically
# -----------------------------------------------------------------------------
<IfModule mod_rewrite.c>
    # Check if browser accepts AVIF
    RewriteCond %{HTTP_ACCEPT} image/avif
    RewriteCond %{REQUEST_URI} ^/assets/webp/(.+)\.webp$
    RewriteCond %{DOCUMENT_ROOT}/assets/avif/%1.avif -f
    RewriteRule ^assets/webp/(.+)\.webp$ /assets/avif/$1.avif [T=image/avif,L]
    
    # Check if browser accepts WebP (fallback from PNG requests)
    RewriteCond %{HTTP_ACCEPT} image/webp
    RewriteCond %{REQUEST_URI} ^/assets/png-fallback/(.+)\.png$
    RewriteCond %{DOCUMENT_ROOT}/assets/webp/%1.webp -f
    RewriteRule ^assets/png-fallback/(.+)\.png$ /assets/webp/$1.webp [T=image/webp,L]
</IfModule>

# -----------------------------------------------------------------------------
# Security Headers
# -----------------------------------------------------------------------------
<IfModule mod_headers.c>
    # Prevent MIME type sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # Referrer policy
    Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# -----------------------------------------------------------------------------
# Prevent Directory Listing
# -----------------------------------------------------------------------------
Options -Indexes

# -----------------------------------------------------------------------------
# Block access to sensitive files
# -----------------------------------------------------------------------------
<FilesMatch "^\.">
    Require all denied
</FilesMatch>
